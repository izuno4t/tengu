# 画面レイアウト仕様（tengu）

本書は、tenguの表示領域の仕様を定義する。

本書では、実行時の全体表示領域を「ウィンドウ」と定義する。  
ウィンドウ内の各表示領域を「エリア」と定義する。

## 1. 基本的な特徴

tenguは以下の特徴を持つ表示方式を採用する。

| 特徴 | 説明 |
| --- | --- |
| インライン描画 | オルタネートスクリーンを使わず、通常のターミナルバッファに直接描画する |
| ストリーミング出力 | LLMの応答を受信しながらリアルタイムで表示する |
| スクロールバック保持 | 過去の出力がターミナルの履歴に残る |
| 動的高さ | コンテンツ量に応じて表示領域が伸縮する |

## 2. ウィンドウサイズの説明

初期ウィンドウの高さは、TUI起動時点のターミナル表示領域の行数とする。  
初期ウィンドウの行数は、以下の構成で消費される。

- ヘッダーエリア: 1行（起動時に表示し、以降はスクロールバックに流す）
- 結果エリア: 最低3行（ログ量に応じて増減）
- 余白: 1行（補助要素）
- 区切り線: 1行（補助要素）
- 入力エリア: 1行以上（改行数に応じて拡大、処理ステータス表示を含む）
- スラッシュヘルプエリア: 0行以上（`/` 入力時のみ表示）
- フッターエリア: 1行

### 2.1 ウィンドウの縦方向拡張仕様

- ウィンドウは下方向に拡張する。
- 下方向の限界に達した場合、上方向に拡張する。
- 上方向の限界に達した場合は、ウィンドウのスクロールに任せる（仮想的には拡大する）。
- 限界とは、起動時に確定したウィンドウ高（ターミナル可視領域の行数）の上限に到達した状態を指す。

## 3. エリア一覧（上から下）

1. ヘッダーエリア
2. 結果エリア（ログ出力）
3. 入力エリア（可変、処理ステータス表示を内包）
4. スラッシュヘルプエリア（`/` 入力時のみ表示）
5. フッターエリア（左: model/build、右: ショートヘルプ［灰色］）

## 4. エリアレイアウト

```text
┌──────────────────────────────────────────────┐
│ ヘッダーエリア                               │
└──────────────────────────────────────────────┘
┌──────────────────────────────────────────────┐
│ 結果エリア                                   │
│ …                                            │
└──────────────────────────────────────────────┘
┌──────────────────────────────────────────────┐
│ （余白 1行）                                 │
└──────────────────────────────────────────────┘
┌──────────────────────────────────────────────┐
│ 入力エリア（ステータス表示を内包）           │
└──────────────────────────────────────────────┘
────────────────────────────────────────────────
┌──────────────────────────────────────────────┐
│ スラッシュヘルプエリア                        │
└──────────────────────────────────────────────┘
┌──────────────────────────────────────────────┐
│ フッターエリア                               │
└──────────────────────────────────────────────┘
```

## 5. 各エリアの仕様

### 5.1 ヘッダーエリア

- アプリ起動時の識別情報（例: `👺 Tengu - Interactive mode`）を表示する。
- 1行固定だが、インライン描画のためスクロールバックに流れる。

### 5.2 結果エリア（ログ出力）

- ユーザー入力とLLMの応答ログを表示する。
- 結果エリアの高さは、ウィンドウ内の残り行数に応じて決まる。
- 他エリアが追加の行数を必要とする場合、結果エリアがその受け皿となって行数を渡す。
- 起動時は最低3行を確保し、ログの増加に応じて下方向に拡大する。
- 下方向の限界に達したら上方向に拡大する。
- 上方向の限界に達した場合は、ウィンドウのスクロールに任せる（仮想的には拡大する）。
- 限界とは、起動時に確定したウィンドウ高（ターミナル可視領域の行数）の上限に到達した状態を指す。
- 一度5行以上に拡大した場合、5行未満には縮小しない。

### 5.3 入力エリア

- ユーザーの入力を受け付ける。
- 初期は1行。
- 改行入力が増えた分だけ領域を拡大する。
- 処理ステータスは入力エリア内に統合して表示する（例: `• status: idle`）。
- 処理ステータスの表示行は内容量に応じて拡張する。
- 入力プロンプトは「現在のインタラクションの末尾」に表示する。

### 5.4 スラッシュヘルプエリア

- `/` 入力中にコマンドヘルプを表示する。
- 不要時は非表示（高さ0）。

### 5.5 フッターエリア

- 左側にアプリステータス（model/build）を表示する。
- 右側にショートヘルプ（`Ctrl+C to quit • ? for shortcuts`）を表示する。
- 1行固定。
- 文字色は明るいグレー。
- インライン描画と両立するため、ANSIエスケープで固定位置に再描画する（実現できない場合は入力近傍に表示）。

## 6. 全体仕様

- 余白や区切り線はエリアとは別の補助要素として扱う。
- 結果エリアと処理ステータスの間に常に1行の余白を入れる。
- 区切り線は入力エリアの上部に表示する。
- 区切り線の色は明るいグレー。

## 7. 重要な動作メカニズム

### 7.1 上書き描画（Repaint）

- 入力中や処理中のステータス表示は、同じ行を上書き更新する。
- ANSIエスケープシーケンスで行クリア・カーソル移動を行う。
- `\r`（キャリッジリターン）+ `\x1b[K`（行末までクリア）の組み合わせを使う。

### 7.2 ストリーミング応答

- 受信chunk → 即座に出力 → カーソル位置更新 → 次のchunk待ち、を繰り返す。
- 応答は完了を待たずに逐次表示する。
- 入力プロンプトは応答完了後に再表示する。

### 7.3 入力プロンプトの位置

- 入力プロンプト（`>`）は現在のインタラクションの末尾に表示する。
- 出力が増えると自動的にスクロール（ターミナル任せ）。

## 8. 実装方針

- 出力方式: ストリーミング（逐次）
- 領域管理: ターミナル任せ
- 再描画: 差分更新（必要最小限）

## 9. 実装のポイント

1. ストリーミング対応: LLMからのchunkを受信次第stdoutに出力する。
2. 行単位の上書き: ステータス行のみANSIエスケープで更新する。
3. スクロールはターミナル任せ: 自前でスクロール管理しない。
4. 入力プロンプトの再描画: 応答完了後に入力行を再表示する。

## 10. UI要素の仕様

### 10.1 ツール実行許可UI

- ツール（ファイル編集、Bash実行など）実行前に許可ダイアログを表示する。
- 表示位置は入力プロンプト近傍とし、スクロールバックに残る。
- 例: `Allow Edit to /path/to/file?`
  `[y] Yes  [n] No  [a] Always allow  [d] Don't ask again`
- キーバインド: `y/n/a/d` を必須とする。

### 10.2 Markdownレンダリング

- 結果エリアはMarkdownをレンダリングする。
- コードブロックは言語表示とシンタックスハイライトを行う。
- リスト、ヘッダー、強調表示をサポートする。

### 10.9 テーマ（配色）

- TUIの配色は `src/tui/theme.toml` をデフォルトとして使用する。
- `~/.tengu/theme.toml` が存在する場合、同名キーで上書きする。
- 未指定キーはデフォルト配色を使用する。

### 10.3 コスト/トークン表示

- セッションのトークン使用量・コストをフッターエリアで表示できるようにする。
- 表示形式は「tokens/cost」を標準とし、非表示設定も許容する。

### 10.4 ユーザー入力とAI応答の視覚的区別

- ユーザー入力は `>` プレフィックスで表示する。
- AI応答はインデント、色、または接頭辞で区別する。

### 10.5 思考表示（Thinking）

- 思考プロセスは折りたたみ可能な形式で表示する。
- 折りたたみの既定状態は「閉じる」。

### 10.6 プログレス/スピナー表示

- 処理中はスピナーを表示する。
- スピナーは処理ステータス表示に統合する。

### 10.7 Todoリスト表示

- タスク管理UIはチェックボックスとステータス色で表示する。

### 10.8 エラー表示

- エラーは色とアイコンで区別する。
- スタックトレースは折りたたみ可能とする。
